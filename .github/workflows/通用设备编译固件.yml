name: 通用设备编译固件
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Select branch"
        required: false
        default: "lede-master"
        type: choice
        options:
          - openwrt-main
          - lede-master
          - immortalwrt-master
          - Lienol-master
      openwrt_storage:
        description: "Storage"
        required: false
        default: "generic"
        type: string
env:
  FEEDS_CONF: config/${{ inputs.source_branch }}/feeds.conf.default
  CONFIG_FILE: config/${{ inputs.source_branch }}/config
  DIY_P1_SH: config/${{ inputs.source_branch }}/diy-part1.sh
  DIY_P2_SH: config/${{ inputs.source_branch }}/diy-part2.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  DEVICE_NAME: "generic"
jobs:
  build:
    runs-on: ubuntu-22.04
    if: ${{ github.event.repository.owner.id == github.event.sender.id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Init env
        id: init
        run: |
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d
          sudo sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
          sudo apt update && sudo apt install -y $(curl -fsSL https://is.gd/depend_ubuntu2204_openwrt)
          sudo apt autoremove -y && sudo apt clean
          sudo fallocate -l 4G /swapfile && sudo chmod 600 /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile
          echo "FILE_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
      - name: Clone code
        id: codes
        working-directory: /workdir
        if: ${{ steps.init.outputs.status == 'success' }}
        run: |
          mkdir -p /workdir
          if [[ "${{ inputs.source_branch }}" == *lede* ]]; then
            git clone --depth=1 https://github.com/coolsnowwolf/lede /workdir/openwrt
          else
            git clone --depth=1 https://github.com/openwrt/openwrt /workdir/openwrt
          fi
          ln -sf /workdir/openwrt ${GITHUB_WORKSPACE}/openwrt
          echo "status=success" >> $GITHUB_OUTPUT
      - name: Feeds
        run: |
          cd openwrt
          [[ -f "${{ env.FEEDS_CONF }}" ]] && cp ${{ env.FEEDS_CONF }} feeds.conf.default
          ./scripts/feeds update -a && ./scripts/feeds install -a
          [[ -f "${{ env.DIY_P1_SH }}" ]] && chmod +x ${{ env.DIY_P1_SH }} && ${{ env.DIY_P1_SH }}
      - name: Config
        run: |
          cd openwrt
          [[ -f "${{ env.CONFIG_FILE }}" ]] && cp ${{ env.CONFIG_FILE }} .config
          [[ -f "${{ env.DIY_P2_SH }}" ]] && chmod +x ${{ env.DIY_P2_SH }} && ${{ env.DIY_P2_SH }}
      - name: Download
        run: cd openwrt && make defconfig && make download -j4
      - name: Compile
        id: compile
        run: |
          cd openwrt
          make -j2 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
      - name: Upload bin
        uses: actions/upload-artifact@v4
        if: ${{ steps.compile.outputs.status == 'success' }}
        with:
          name: OpenWrt_bin_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}
          path: openwrt/bin
      - name: Upload firmware
        if: ${{ steps.compile.outputs.status == 'success' }}
        run: |
          cd openwrt/bin/targets/*/* && rm -rf packages
          echo "FIRMWARE=$(pwd)" >> $GITHUB_ENV
      - name: Release
        uses: softprops/action-gh-release@v1
        if: ${{ steps.compile.outputs.status == 'success' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: OpenWrt_${{ env.FILE_DATE }}
          files: ${{ env.FIRMWARE }}/*
          body: |
            Default IP: 192.168.123.1
            Username: root
            Password: password
